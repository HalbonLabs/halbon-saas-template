name: Security - SCA

on:
  push:
    branches: [ main ]
    paths:
      - package.json
      - pnpm-lock.yaml
  pull_request:
    branches: [ main ]
    paths:
      - package.json
      - pnpm-lock.yaml
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch: {}

concurrency:
  group: security-sca-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  deps:
    name: Deps-only scan
    if: >-
      github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      TRIVY_CACHE_DIR: .trivycache
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.6 renovate: datasource=github-releases depName=actions/checkout
      - name: Cache Trivy DB
        uses: actions/cache@v4 # renovate: datasource=github-releases depName=actions/cache
        with:
          path: |
            .trivycache
          key: ${{ runner.os }}-trivy-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-trivy-
      - name: Scan lockfile (SARIF)
        uses: aquasecurity/trivy-action@b49f0bd0f9320edaa1dfc6d0c484b99e5a8cd6e7 # v0.20.0 renovate: datasource=github-releases depName=aquasecurity/trivy-action
        with:
          scan-type: fs
          scan-ref: pnpm-lock.yaml
          format: sarif
          output: trivy-deps-lockfile.sarif
          severity: HIGH,CRITICAL
          exit-code: '0'
          ignore-unfixed: true
      - name: Upload SARIF (lockfile)
        if: always()
        uses: github/codeql-action/upload-sarif@v3 # renovate: datasource=github-releases depName=github/codeql-action
        with:
          sarif_file: trivy-deps-lockfile.sarif
          category: trivy-deps-lockfile
      - name: Scan lockfile (table)
        uses: aquasecurity/trivy-action@b49f0bd0f9320edaa1dfc6d0c484b99e5a8cd6e7 # v0.20.0 renovate: datasource=github-releases depName=aquasecurity/trivy-action
        with:
          scan-type: fs
          scan-ref: pnpm-lock.yaml
          format: table
          severity: HIGH,CRITICAL
          exit-code: '1'
          ignore-unfixed: true
      - name: Scan manifest (SARIF)
        uses: aquasecurity/trivy-action@b49f0bd0f9320edaa1dfc6d0c484b99e5a8cd6e7 # v0.20.0 renovate: datasource=github-releases depName=aquasecurity/trivy-action
        with:
          scan-type: fs
          scan-ref: package.json
          format: sarif
          output: trivy-deps-manifest.sarif
          severity: HIGH,CRITICAL
          exit-code: '0'
          ignore-unfixed: true
      - name: Upload SARIF (manifest)
        if: always()
        uses: github/codeql-action/upload-sarif@v3 # renovate: datasource=github-releases depName=github/codeql-action
        with:
          sarif_file: trivy-deps-manifest.sarif
          category: trivy-deps-manifest
      - name: Scan manifest (table)
        uses: aquasecurity/trivy-action@b49f0bd0f9320edaa1dfc6d0c484b99e5a8cd6e7 # v0.20.0 renovate: datasource=github-releases depName=aquasecurity/trivy-action
        with:
          scan-type: fs
          scan-ref: package.json
          format: table
          severity: HIGH,CRITICAL
          exit-code: '1'
          ignore-unfixed: true

  weekly:
    name: Full repo weekly scan
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      TRIVY_CACHE_DIR: .trivycache
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.6 renovate: datasource=github-releases depName=actions/checkout
      - name: Cache Trivy DB
        uses: actions/cache@v4 # renovate: datasource=github-releases depName=actions/cache
        with:
          path: |
            .trivycache
          key: ${{ runner.os }}-trivy-full-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-trivy-full-
      - name: Run full filesystem scan (SARIF)
        uses: aquasecurity/trivy-action@b49f0bd0f9320edaa1dfc6d0c484b99e5a8cd6e7 # v0.20.0 renovate: datasource=github-releases depName=aquasecurity/trivy-action
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-full.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'
          ignore-unfixed: true
          timeout: '15m'
          skip-files: |
            **/.next/**
            **/node_modules/**
            **/coverage/**
            **/.turbo/**
      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3 # renovate: datasource=github-releases depName=github/codeql-action
        with:
          sarif_file: trivy-full.sarif
          category: trivy-full
      - name: Run full filesystem scan (table)
        uses: aquasecurity/trivy-action@b49f0bd0f9320edaa1dfc6d0c484b99e5a8cd6e7 # v0.20.0 renovate: datasource=github-releases depName=aquasecurity/trivy-action
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          ignore-unfixed: true
          timeout: '15m'
          skip-files: |
            **/.next/**
            **/node_modules/**
            **/coverage/**
            **/.turbo/**

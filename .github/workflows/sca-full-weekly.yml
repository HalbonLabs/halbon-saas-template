name: Security - SCA (Full Repo Weekly)

on:
  schedule:
    - cron: '0 3 * * 1' # Mondays at 03:00 UTC
  workflow_dispatch: {}

concurrency:
  group: sca-full-weekly
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  trivy-full:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      TRIVY_CACHE_DIR: .trivycache
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0 renovate: datasource=github-releases depName=actions/checkout
      - name: Cache Trivy DB
        uses: actions/cache@v4 # renovate: datasource=github-releases depName=actions/cache
        with:
          path: | 
            .trivycache
          key: ${{ runner.os }}-trivy-full-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-trivy-full-
      - name: Install Trivy
        uses: aquasecurity/trivy-action@b49f0bd0f9320edaa1dfc6d0c484b99e5a8cd6e7 # v0.20.0 renovate: datasource=github-releases depName=aquasecurity/trivy-action
      - name: Run full filesystem scan (SARIF)
        uses: aquasecurity/trivy-action@b49f0bd0f9320edaa1dfc6d0c484b99e5a8cd6e7 # v0.20.0 renovate: datasource=github-releases depName=aquasecurity/trivy-action
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-full.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'
          ignore-unfixed: true
          timeout: '15m'
          # Reduce noise and runtime
          skip-files: |
            **/.next/**
            **/node_modules/**
            **/coverage/**
            **/.turbo/**
      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3 # renovate: datasource=github-releases depName=github/codeql-action
        with:
          sarif_file: trivy-full.sarif
          category: trivy-full
      - name: Run full filesystem scan (table, fail on HIGH+)
        uses: aquasecurity/trivy-action@b49f0bd0f9320edaa1dfc6d0c484b99e5a8cd6e7 # v0.20.0 renovate: datasource=github-releases depName=aquasecurity/trivy-action
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          ignore-unfixed: true
          timeout: '15m'
          skip-files: |
            **/.next/**
            **/node_modules/**
            **/coverage/**
            **/.turbo/**
